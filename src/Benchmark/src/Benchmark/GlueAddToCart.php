<?php

require_once __DIR__ . '/../../bootstrap.php';

$url = GLUE_BASE_URL;

$uniqId = uniqid('', true);

$skus = [
    '001_25904006',
    '002_25904004',
    '003_26138343',
    '004_30663302',
    '005_30663301',
    '006_30692993',
    '007_30691822',
    '008_30692992',
    '009_30692991',
    '010_30692994',
    '011_30775359',
    '012_25904598',
    '013_25904584',
    '014_25919241',
    '015_25904009',
    '016_21748907',
    '017_21748906',
    '018_21081477',
    '019_21081473',
    '020_21081478',
    '021_21081475',
    '023_21758366',
    '024_21987578',
    '025_21764665',
    '026_21748904',
    '027_26976107',
    '028_26976108',
    '029_26976109',
    '030_30021698',
    '031_30021637',
    '032_32125551',
    '033_32125568',
    '034_32125390',
    '037_25904011',
    '038_25905593',
    '039_25904010',
    '040_25904665',
    '041_25904691',
    '042_31040075',
    '043_31040074',
    '044_31040076',
    '045_26408558',
    '046_26408563',
    '047_26408568',
    '048_26403666',
    '049_30395396',
    '050_31080444',
    '051_29567823',
    '051_30107816',
    '051_30614390',
    '052_29567823',
    '052_30107816',
    '052_30614390',
    '053_29567823',
    '053_30107816',
    '053_30614390',
    '054_29406182',
    '055_29406184',
    '056_31714843',
    '057_32007641',
    '058_24245592',
    '058_26175504',
    '059_24245592',
    '059_26175504',
    '059_26027598',
    '060_24245592',
    '060_26175504',
    '060_26027598',
    '061_24752508',
    '062_24752467',
    '063_29231675',
    '064_18404924',
    '065_23294027',
    '066_23294028',
    '067_24241408',
    '068_21927453',
    '069_21919624',
    '070_133745031',
    '070_203704321',
    '070_133913221',
    '070_133745032',
    '070_203704322',
    '070_133913222',
    '070_133745033',
    '071_26974343',
    '072_19618271',
    '072_21927455',
    '073_19618271',
    '073_21927455',
    '074_29641053',
    '075_29401702',
    '079_24394211',
    '080_24394206',
    '081_22196533',
    '082_22196536',
    '083_30964018',
    '084_30964019',
    '085_29901936',
    '086_30521602',
    '087_29901938',
    '088_29634940',
    '089_29634947',
    '090_24495844',
    '091_25873091',
    '092_24495842',
    '093_24495843',
    '094_27033003',
    '095_24235707',
    '096_30856274',
    '097_27290499',
    '098_26192836',
    '099_27207215',
    '100_24675726',
    '101_29727910',
    '102_30727008',
    '103_30727011',
    '104_30727010',
    '105_30727013',
    '106_30727014',
    '107_30727016',
    '108_21047360',
    '109_19416433',
    '110_19682159',
    '111_12295890',
    '112_312526171',
    '112_306918001',
    '112_312526191',
    '112_312526172',
    '112_306918002',
    '112_312526192',
    '112_306918003',
    '112_312526193',
    '113_29885591',
    '114_29911081',
    '114_30580483',
    '115_27295368',
    '115_26440118',
    '115_26408656',
    '116_29743424',
    '116_28684053',
    '117_29890338',
    '117_30585828',
    '118_29804739',
    '119_29804808',
    '120_29890350',
    '120_30069636',
    '120_30069631',
    '121_29406823',
    '121_28542963',
    '121_28549476',
    '122_22308524',
    '122_26145672',
    '123_29866607',
    '123_30610368',
    '123_29866603',
    '124_31623088',
    '124_29866591',
    '125_30703764',
    '125_30350012',
    '126_24722439',
    '126_30407844',
    '126_26280142',
    '127_22828284',
    '127_22613708',
    '127_20723326',
    '127_22613709',
    '128_29955336',
    '128_27314278',
    '129_30706500',
    '129_27107297',
    '129_24325712',
    '130_29285281',
    '130_24326086',
    '130_24725761',
    '131_24872891',
    '132_30619567',
    '133_31743669',
    '134_29759322',
    '134_26145012',
    '135_29836399',
    '135_30359386',
    '136_24425591',
    '137_29283479',
    '137_29283480',
    '138_30046855',
    '138_30657838',
    '139_24699831',
    '140_22766487',
    '141_29380410',
    '142_30943081',
    '143_31035196',
    '144_29804740',
    '144_30312874',
    '144_29804741',
    '145_29885470',
    '145_29885471',
    '145_29885473',
    '146_30706737',
    '146_30213351',
    '147_27295351',
    '147_30046188',
    '148_25977678',
    '148_25977676',
    '148_27282150',
    '149_30283566',
    '149_28346778',
    '150_29554292',
    '151_30983682',
    '152_27104941',
    '152_29810130',
    '153_26178487',
    '153_29805122',
    '153_29805124',
    '154_31980499',
    '154_31266921',
    '155_32122450',
    '155_30149933',
    '156_32018944',
    '157_29525342',
    '158_29885222',
    '159_29885260',
    '159_29885269',
    '160_29533301',
    '161_29533300',
    '162_29533299',
    '163_29728850',
    '164_29565390',
    '165_29879507',
    '165_29879528',
    '166_30230575',
    '166_29565389',
    '167_30375366',
    '167_30375364',
    '168_29379693',
    '168_21844742',
    '169_25880805',
    '170_28516206',
    '170_28549472',
    '171_27262160',
    '172_29801891',
    '173_26973306',
    '174_27253016',
    '175_26564922',
    '175_26935356',
    '176_29209306',
    '176_29381409',
    '176_29536449',
    '177_24867659',
    '177_24422865',
    '177_25913296',
    '178_29658415',
    '179_29658416',
    '180_32127058',
    '181_31995510',
    '182_30345097',
    '183_21811723',
    '184_17365820',
    '184_17494387',
    '184_17560323',
    '185_25904533',
    '186_25904506',
    '187_26306352',
    '188_26306353',
    '189_30150732',
    '190_25111746',
    '191_17681791',
    '192_17738941',
    '193_32124735',
    '194_25904145',
    '195_25904159',
    '196_23120327',
    '197_21421718',
    '198_19692589',
    '199_7016823',
    '199_24788780',
    '200_5787536',
    '201_11217755',
    '202_5782479',
    '203_15619960',
    '204_29851280',
    '205_6350138',
    '206_6429825',
    '207_15721464',
    '208_14678762',
    '209_12554247',
    '210_123',
    '211_123',
    '212_123',
    '213_123',
    '214_123',
];

$skus = array_slice($skus, 0, $argv[1] ?? 100);

$cartId = null;
foreach ($skus as $index => $sku) {

    $time = microtime(true);

    $curl = curl_init();

    curl_setopt_array($curl, array(
        CURLOPT_URL => $url . '/guest-cart-items',
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_ENCODING => '',
        CURLOPT_MAXREDIRS => 10,
        CURLOPT_TIMEOUT => 30,
        CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
        CURLOPT_CUSTOMREQUEST => 'POST',
        CURLOPT_POSTFIELDS => '{"data": {"type": "guest-cart-items", "attributes": {"sku": "' . $sku . '", "quantity": 1}}}',
        CURLOPT_HTTPHEADER => array(
            'Content-Type: application/json',
            'X-Anonymous-Customer-Unique-Id: ' . $uniqId,
            'cache-control: no-cache'
        ),
    ));

    $response = curl_exec($curl);
    $err = curl_error($curl);

    curl_close($curl);

    echo str_pad($index, 5);
    echo '[' . str_pad(round(microtime(true) - $time, 3) . 's', 5) . ']   ';

    if ($err) {
        echo 'Failed: ' . $sku . ' (' . $err . ')' . PHP_EOL;

    } else {
        $cartId = (json_decode($response, true) ?: [])['data']['id'] ?? $cartId;
        echo $sku . ' - done' . PHP_EOL;
    }
}

if ($cartId) {
    $curl = curl_init();

    curl_setopt_array($curl, array(
        CURLOPT_URL => $url . '/guest-carts/' . $cartId . '?include=guest-cart-items',
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_ENCODING => '',
        CURLOPT_MAXREDIRS => 10,
        CURLOPT_TIMEOUT => 30,
        CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
        CURLOPT_CUSTOMREQUEST => 'GET',
        CURLOPT_HTTPHEADER => array(
            'Content-Type: application/json',
            'X-Anonymous-Customer-Unique-Id: ' . $uniqId,
            'cache-control: no-cache'
        ),
    ));
    $response = curl_exec($curl);
    $itemsInCart = count(json_decode($response, false)->included ?? []);
    echo PHP_EOL . 'Items in cart: ' . $itemsInCart . PHP_EOL;

    if ($itemsInCart === 0) {
        exit(1);
    }
}
